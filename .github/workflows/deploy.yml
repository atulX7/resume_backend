name: Deploy FastAPI to Ubuntu EC2

on:
  push:
    branches:
      - neelam-cicd  # Change to your deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # âœ… Step 1: Checkout repository
    - name: Checkout code
      uses: actions/checkout@v3

    # âœ… Step 2: Deploy to EC2
    - name: Deploy FastAPI Backend to EC2
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ”„ Connecting to EC2 instance..."
          # âœ… Step 3.1: Ensure Backend Directory Exists
          echo "ğŸ”„ Checking if fastapi_app directory exists..."
          if [ -d "~/fastapi_app" ]; then
            echo "ğŸ›‘ Directory exists. Deleting and recreating..."
            rm -rf ~/fastapi_app
          fi
          mkdir -p ~/fastapi_app
          echo "âœ… Directory ready."

          # âœ… Step 3.2: Clone Code
          echo "ğŸ“¥ Pulling latest code..."
            if [ ! -d ".git" ]; then
              git clone -b neelam-cicd https://github.com/atulX7/resume_backend.git ~/fastapi_app
            else
              git reset --hard
              git pull origin main
            fi

          # âœ… Step 3.3: Install Python & Dependencies
          echo "ğŸ Ensuring Python & Virtual Environment"
          sudo apt update -y
          sudo apt install -y python3.12 python3.12-venv python3.12-dev

          # âœ… Step 3.4: Set Up Virtual Environment & Install Dependencies
          cd ~/fastapi_app
          python3.12 -m venv venv
          source venv/bin/activate
          pip install poetry
          poetry install --no-root
          echo "âœ… Dependencies installed."

          # âœ… Step 3.5: Create .env File with GitHub Secrets
          echo "ğŸ“Œ Creating .env file"
          cat <<EOF > .env
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          EOF
          echo "âœ… .env file created."

          # âœ… Step 3.6: Apply Alembic Migrations
          echo "ğŸ› ï¸ Applying Alembic Migrations..."
          alembic upgrade head
          echo "âœ… Database migrations applied."

          # âœ… Step 3.7: Configure & Restart FastAPI with Systemd
          echo "ğŸš€ Restarting FastAPI Application..."
          if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ Installing PM2..."
              sudo npm install -g pm2
          fi
          pm2 restart fastapi_app || pm2 start "poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload" --name fastapi_app

          echo "âœ… FastAPI Service Restarted Successfully!"
        

    # âœ… Step 4: Verify Deployment
    - name: Verify FastAPI Deployment
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ› ï¸ Checking FastAPI status..."
          sudo systemctl status fastapi --no-pager
          curl -f http://localhost:8000/docs || (echo "âŒ FastAPI is NOT running!" && exit 1)
          echo "âœ… FastAPI is running successfully!"
  
